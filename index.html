<HTML><HEAD>
<TITLE>ps2tek - Documentation on PS2 internals</title>
</HEAD><BODY bgcolor="#FFFFFF" text="#000000" link="#0033cc" vlink="#0033cc" alink="#0033cc">
  <TABLE WIDTH=100% BORDER=0 CELLSPACING=0 CELLPADDING=0><TR bgcolor="#cccccc"><TD><FONT SIZE=+2>
  <A NAME="contents"></A>&nbsp;
  Contents
</FONT></TD></TR></TABLE><BR>
  <A HREF="#iomaps">I/O Maps</A><BR>
  <A HREF="#eeintc">EE Interrupt Controller (INTC)</A><BR>
  <A HREF="#cdvd">CDVD Drive</A><BR>
  <A HREF="#iopint">IOP Interrupts</A><BR>
  <BR>
  <TABLE WIDTH=100% BORDER=0 CELLSPACING=0 CELLPADDING=0><TR bgcolor="#cccccc"><TD><FONT SIZE=+2>
  <A NAME="iomaps"></A>&nbsp;
  I/O Maps
</FONT></TD></TR></TABLE><BR>
EE Map<BR>
<B>EE Timers</B><BR>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0><TR><TD><PRE>
  100000xxh        Timer 0
  100008xxh        Timer 1
  100010xxh        Timer 2
  100018xxh        Timer 3
</TD></TR></TABLE>
<B>Image Processing Unit (IPU)</B><BR>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0><TR><TD><PRE>
  10002000h 8h     IPU Command
  10002010h 4h     IPU Control
  10002020h 4h     IPU bit pointer control
  10002030h 8h     Top of bitstream
  10007010h 10h    In FIFO
</TD></TR></TABLE>
<B>DMA Controller (DMAC)</B><BR>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0><TR><TD><PRE>
  100080xxh        VIF0 - channel 0
  100090xxh        VIF1 - channel 1
  1000A0xxh        GIF - channel 2
  1000B0xxh        IPU_FROM - channel 3
  1000B4xxh        IPU_TO - channel 4
  1000C0xxh        SIF0 - channel 5
  1000C4xxh        SIF1 - channel 6
  1000C?xxh        SIF2 - channel 7
  1000D0xxh        SPR_FROM - channel 8
  1000D4xxh        SPR_TO - channel 9
  1000E000h 4h     D_CTRL - DMAC control
  1000E010h 4h     D_STAT - DMAC interrupt status
  1000E020h 4h     D_PCR - DMAC priority control
  1000E030h 4h     D_SQWC - DMAC skip quadword
  1000E040h 4h     D_RBSR - DMAC ringbuffer start
  1000E050h 4h     D_RBOR - DMAC ringbuffer offset
  1000E060h 4h     D_STADR - DMAC stall address
</TD></TR></TABLE>
<B>Interrupt Controller (INTC)</B><BR>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0><TR><TD><PRE>
  1000F000h 4h     INTC_STAT - Interrupt status
  1000F010h 4h     INTC_MASK - Interrupt mask
</TD></TR></TABLE>
<B>Subsystem Interface (SIF)</B><BR>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0><TR><TD><PRE>
  1000F200h 4h     MSCOM - EE->IOP communication
  1000F210h 4h     SMCOM - IOP->EE communication
  1000F220h 4h     MSFLAG - EE->IOP flags
  1000F230h 4h     SMFLAG - IOP->EE flags
  1000F240h 4h     Control register
</TD></TR></TABLE>
<B>Privileged GS registers</B><BR>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0><TR><TD><PRE>
  12000000h 8h     PMODE - various PCRTC controls
  12000010h 8h     SMODE1
  12000020h 8h     SMODE2
  12000030h 8h     SRFSH
  12000040h 8h     SYNCH1
  12000050h 8h     SYNCH2
  12000060h 8h     SYNCV
  12000070h 8h     DISPFB1 - display buffer for output circuit 1
  12000080h 8h     DISPLAY1 - output circuit 1 control
  12000090h 8h     DISPFB2 - display buffer for output circuit 2
  120000A0h 8h     DISPLAY2 - output circuit 2 control
  120000B0h 8h     EXTBUF
  120000C0h 8h     EXTDATA
  120000D0h 8h     EXTWRITE
  120000E0h 8h     BGCOLOR - background color
  12001000h 8h     GS_CSR - control register
  12001010h 8h     GS_IMR - GS interrupt control
  12001040h 8h     BUSDIR - transfer direction
  12001080h 8h     SIGLBLID - signal
</TD></TR></TABLE><BR>
IOP Map<BR>
<B>Subsystem Interface (SIF)</B><BR>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0><TR><TD><PRE>
  1D000000h 4h     MSCOM - EE->IOP communication
  1D000010h 4h     SMCOM - IOP->EE communication
  1D000020h 4h     MSFLAG - EE->IOP flags
  1D000030h 4h     SMFLAG - IOP->EE flags
  1D000040h 4h     Control register
</TD></TR></TABLE>
<B>CDVD Drive</B><BR>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0><TR><TD><PRE>
  1F402004h 1h     Current N command
  1F402005h 1h     N command status (R)
  1F402005h 1h     N command params (W)
  1F402006h 1h     Error
  1F402007h 1h     Send BREAK command
  1F402008h 1h     CDVD I_STAT - interrupt register
  1F40200Ah 1h     Drive status
  1F40200Fh 1h     Disk type
  1F402016h 1h     Current S command
  1F402017h 1h     S command status
  1F402018h 1h     S command params
</TD></TR></TABLE>
<B>Interrupt Control</B><BR>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0><TR><TD><PRE>
  1F801070h 4h     I_STAT - Interrupt status
  1F801074h 4h     I_MASK - Interrupt mask
  1F801078h 1h     I_CTRL - Global interrupt disable
</TD></TR></TABLE>
<B>DMA registers</B><BR>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0><TR><TD><PRE>
  1F80108xh        MDECin - channel 0
  1F80109xh        MDECout - channel 1
  1F8010Axh        SIF2 (GPU) - channel 2
  1F8010Bxh        CDVD - channel 3
  1F8010Cxh        SPU2 Core0 - channel 4
  1F8010Dxh        PIO - channel 5
  1F8010Exh        OTC - channel 6
  1F80150xh        SPU2 Core1 - channel 8
  1F80151xh        ??? - channel 9
  1F80152xh        SIF0 - channel 10
  1F80153xh        SIF1 - channel 11
  1F80154xh        SIO2in - channel 12
  1F80155xh        SIO2out - channel 13
  
  1F8010F0h 4h     DPCR - DMA priority control
  1F8010F4h 4h     DICR - DMA interrupt control
  1F801570h 4h     DPCR2 - DMA priority control 2
  1F801574h 4h     DICR2 - DMA priority control 2
</TD></TR></TABLE>
<B>IOP Timers</B><BR>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0><TR><TD><PRE>
  1F80110xh        Timer 0
  1F80111xh        Timer 1
  1F80112xh        Timer 2
  1F80148xh        Timer 3
  1F80149xh        Timer 4
  1F8014Axh        Timer 5
</TD></TR></TABLE>
<B>Serial Interface (SIO2)</B><BR>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0><TR><TD><PRE>
  1F808200h 40h    SEND3 buffer
  1F808240h 20h    SEND1/2 buffers
  1F808260h 1h     In FIFO
  1F808264h 1h     Out FIFO
  1F808268h 4h     SIO2 control
  1F80826Ch 4h     RECV1
  1F808270h 4h     RECV2
  1F808274h 4h     RECV3
</TD></TR></TABLE>
<B>Sound Processing Unit (SPU2)</B><BR>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0><TR><TD><PRE>
  1F900000h 180h   Core0 Voice 0-23 registers
  1F900190h 4h     Key ON 0/1
  1F900194h 4h     Key OFF 0/1
  1F90019Ah 2h     Core attributes
  1F90019Ch 4h     Interrupt address H/L
  1F9001A8h 4h     DMA transfer address H/L
  1F9001ACh 2h     Internal transfer FIFO
  1F9001B0h 2h     AutoDMA status
  1F9001C0h 120h   Core0 Voice 0-23 start/loop/next addresses
  1F900340h 4h     ENDX 0/1
  1F900344h 2h     Status register
  
  ... above addresses repeat for Core1 starting at 1F900400h ...
  
  1F900760h 2h     Master Volume Left
  1F900762h 2h     Master Volume Right
  1F900764h 2h     Effect Volume Left
  1F900766h 2h     Effect Volume Right
  1F900768h 2h     Core1 External Input Volume Left
  1F90076Ah 2h     Core1 External Input Volume Right
</TD></TR></TABLE><BR>
 
<TABLE WIDTH=100% BORDER=0 CELLSPACING=0 CELLPADDING=0><TR bgcolor="#cccccc"><TD><FONT SIZE=+2>
<A NAME="eeintc"></A>&nbsp;
EE Interrupt Controller (INTC)
</FONT></TD></TR></TABLE><BR>
The EE has two separate interrupt signals: INT0 (raised by INTC) and INT1 (raised by DMAC).<BR>
<BR>
<B>1000F000h INTC_STAT - Interrupt status register (R=Status, W=Acknowledge)</B><BR>
<B>1000F010h INTC_MASK - Interrupt mask register (R/W)</B><BR>
Status: Read INTC_STAT (1=IRQ raised)<BR>
Acknowledge: Write INTC_STAT (0=No effect 1=Clear bit)<BR>
Mask: Read/Write INTC_MASK (0=Disabled 1=Enabled)<BR>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0><TR><TD><PRE>
  0     IRQ0   GS interrupt
  1     IRQ1   SBUS
  2     IRQ2   VBLANK start
  3     IRQ3   VBLANK end
  4     IRQ4   VIF0
  5     IRQ5   VIF1
  6     IRQ6   VU0
  7     IRQ7   VU1
  8     IRQ8   IPU
  9     IRQ9   Timer 0
  10    IRQ10  Timer 1
  11    IRQ11  Timer 2
  12    IRQ12  Timer 3
  13    IRQ13  SFIFO
  14    IRQ14  VU0 Watchdog
</TD></TR></TABLE><BR>
When (INTC_STAT & INTC_MASK), INT0 is asserted on COP0.Cause:8.
When COP0.Status:8 is true, an interrupt occurs, and the EE jumps to 80000200h.<BR>
<BR>
  
<TABLE WIDTH=100% BORDER=0 CELLSPACING=0 CELLPADDING=0><TR bgcolor="#cccccc"><TD><FONT SIZE=+2>
<A NAME="#cdvd"></A>&nbsp;
CDVD Drive
</FONT></TD></TR></TABLE><BR>
Using the CDVD drive, the PS2 has the ability to read CDROMs, single-layer DVDs, and dual-layer DVDs.
It also sports backwards compatibility with the PSX's CDROM drive in PSX mode.<BR>
<BR>
CDVD commands are either asynchronous (N commands) or synchronous (S commands).
Seeks and reads fall into the former category, and miscellaneous commands, such as RTC access, fall into the latter.<BR>
<BR>
<B>CDVD Reference</B>
<A HREF="#cdvdioports">CDVD I/O Ports</A><BR>
<A HREF="#cdvdncommands">CDVD N Commands</A><BR>
<A HREF="#cdvdscommands">CDVD S Commands</A><BR>
<BR>

<TABLE WIDTH=100% BORDER=0 CELLSPACING=0 CELLPADDING=0><TR bgcolor="#cccccc"><TD><FONT SIZE=+2>
<A NAME="cdvdioports"></A>&nbsp;
CDVD I/O Ports
</FONT></TD></TR></TABLE><BR>
<B>1F402004h Current N command (R/W)</B><BR>
Write to this register to send an N command. For a list of N commands, see<BR>
<A HREF="#cdvdncommands">CDVD N Commands</A><BR>
<BR>
<B>1F402005h N command status (R)</B><BR>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0><TR><TD><PRE>
  0     Unused
  1-3   Ready?
  4-5   Unused
  6     Ready
  7     Unused
</TD></TR></TABLE><BR>
This shows if the CDVD drive is ready to receive an N command.
When bit 6 (0x40) is on, an N command can be sent.
Oddly, bits 1-3, when set, also seem to indicate ready status?<BR>
<BR>
<B>1F402005h N command param (W)</B><BR>
Send parameters for an N command here. This must be done BEFORE the N command has been sent via 1F402004h.<BR>
<BR>

<B>1F402006h CDVD error (R)</B><BR>
Any non-zero value indicates an error? Unknown what kind of errors are possible and what their values are.<BR>
<BR>
<B>1F402007h BREAK</B><BR>
Writing any value to this register sends a BREAK command to the CDVD drive, stopping execution of the current N command.<BR>
<BR>
<B>1F402008h CDVD I_STAT (R=Status, W=Acknowledge)</B><BR>
Status = Read I_STAT (1=Reason for IRQ)<BR>
Acknowledge = Write I_STAT (1=Clear bit)<BR>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0><TR><TD><PRE>
  0     (N?) Command complete
  1     Data ready?
  2     Power off pressed
  3     Disk ejected
  4     BS_Power DET?
  5-7   Unused
</TD></TR></TABLE>
When a CDVD IRQ is raised on I_STAT, this register shows the reason for the interrupt.
Bit 1 seems to be raised when a read command completes, but I'm not certain about this...<BR>
Unknown if bit 0 only applies to N commands, although this appears to be the case.<BR>
<BR>
<B>1F40200Ah CDVD drive status (R)</B><BR>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0><TR><TD><PRE>
  00h  Stopped
  02h  Spinning
  06h  Reading
  0Ah  Paused
</TD></TR></TABLE>
<BR>
<B>1F40200Fh CDVD disk type (R)</B><BR>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0><TR><TD><PRE>
  00h  None?
  12h  CDROM
  14h  DVD
  Unknown what other types are possible.
</TD></TR></TABLE>
<B>1F402016h Current S command (R/W)</B><BR>
Write to this register to send an S command. For a list of S commands, see<BR>
<A HREF="#cdvdscommands">CDVD S Commands</A><BR>
<BR>
<B>1F402017h S command status (R)</B><BR>
40h indicates that the CDVD drive can receive an S command. 00h means that it is busy.<BR>
<BR>
<B>1F402018h S command result (R)</B><BR>
When an S command has finished executing, read the result here. Some S commands may require multiple reads.<BR>
<BR>
<B>1F402018h S command params (W)</B><BR>
Parameters must be sent BEFORE the S command is sent.<BR>
<BR>
  
<TABLE WIDTH=100% BORDER=0 CELLSPACING=0 CELLPADDING=0><TR bgcolor="#cccccc"><TD><FONT SIZE=+2>
<A NAME="cdvdncommands"></A>&nbsp;
CDVD N Commands
</FONT></TD></TR></TABLE><BR>

<TABLE WIDTH=100% BORDER=0 CELLSPACING=0 CELLPADDING=0><TR bgcolor="#cccccc"><TD><FONT SIZE=+2>
<A NAME="cdvdscommands"></A>&nbsp;
CDVD S Commands
</FONT></TD></TR></TABLE><BR>

<TABLE WIDTH=100% BORDER=0 CELLSPACING=0 CELLPADDING=0><TR bgcolor="#cccccc"><TD><FONT SIZE=+2>
<A NAME="iopint"></A>&nbsp;
IOP Interrupts
</FONT></TD></TR></TABLE><BR>
Interrupt handling for the IOP is similar to its PSX counterpart.
The main differences are an additional register (I_CTRL) and more interrupt lines.<BR>
<BR>
<B>1F801070h I_STAT - Interrupt status register (R=Status, W=Acknowledge)</B><BR>
<B>1F801074h I_MASK - Interrupt mask register (R/W)</B><BR>
Status: Read I_STAT (1=IRQ raised)<BR>
Acknowledge: Write I_STAT (0=Clear bit 1=No effect)<BR>
Mask: Read/Write I_MASK (0=Disabled 1=Enabled)<BR>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0><TR><TD><PRE>
  0     IRQ0   VBLANK start
  1     IRQ1   GPU (used in PSX mode)
  2     IRQ2   CDVD Drive
  3     IRQ3   DMA
  4     IRQ4   Timer 0
  5     IRQ5   Timer 1
  6     IRQ6   Timer 2
  7     IRQ7   SIO0
  8     IRQ8   SIO1
  9     IRQ9   SPU2
  10    IRQ10  PIO
  11    IRQ11  VBLANK end
  12    IRQ12  DVD? (unknown purpose)
  13    IRQ13  PCMCIA (related to DEV9 expansion slot)
  14    IRQ14  Timer 3
  15    IRQ15  Timer 4
  16    IRQ16  Timer 5
  17    IRQ17  SIO2
  18    IRQ18  HTR0? (unknown purpose)
  19    IRQ19  HTR1?
  20    IRQ20  HTR2?
  21    IRQ21  HTR3?
  22    IRQ22  USB
  23    IRQ23  EXTR? (unknown purpose)
  24    IRQ24  FWRE (related to FireWire)
  25    IRQ25  FDMA? (FireWire DMA?)
  26-31 Unused/garbage
</TD></TR></TABLE><BR>
<B>1F801078h I_CTRL - Global interrupt control (R=Status and Disable, W)</B><BR>
<TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0><TR><TD><PRE>
  0     Disable all interrupts
  1-31  Unused/garbage
</TD></TR></TABLE>
When bit 0=1, all IOP interrupts are disabled. Reading this register returns bit 0 AND clears it, re-enabling interrupts. Writing can set or reset bit 0.<br>
NOTE: There seems to be a 4 cycle delay when re-enabling interrupts via reading I_CTRL.<BR>
<BR>
<B>Raising Interrupts</B><BR>
If I_CTRL && (I_STAT & I_MASK), then COP0.Cause:8 is set. When COP0.Status:8 is also set when this occurs, COP0.Cause.Excode is set to 00h and the IOP jumps to 80000080h, where the interrupt will be processed.
</BODY></HTML>
